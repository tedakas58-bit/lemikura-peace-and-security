<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-btn {
            background: #2d7d7e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .test-btn:hover {
            background: #1e5a5b;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Supabase Connection Test</h1>
        <p>This tool tests the Supabase connection and client initialization.</p>
        
        <div>
            <button class="test-btn" onclick="testLibraryLoad()">Test Library Load</button>
            <button class="test-btn" onclick="testClientCreation()">Test Client Creation</button>
            <button class="test-btn" onclick="testDatabaseConnection()">Test Database Connection</button>
            <button class="test-btn" onclick="testFeedbackInsertion()">Test Feedback Insertion</button>
        </div>
        
        <div id="results"></div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="js/supabase-config.js"></script>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testLibraryLoad() {
            clearResults();
            addResult('ðŸ” Testing Supabase library load...', 'info');
            
            // Wait a bit for library to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (typeof window.supabase !== 'undefined') {
                addResult('âœ… Supabase library loaded successfully', 'success');
                addResult(`ðŸ“¦ Library type: ${typeof window.supabase}`, 'info');
                addResult(`ðŸ”§ createClient available: ${typeof window.supabase.createClient === 'function'}`, 'info');
            } else {
                addResult('âŒ Supabase library not loaded', 'error');
            }
            
            if (typeof supabaseConfig !== 'undefined') {
                addResult('âœ… Supabase config loaded', 'success');
                addResult(`ðŸ”— URL: ${supabaseConfig.url}`, 'info');
                addResult(`ðŸ”‘ Key: ${supabaseConfig.anonKey.substring(0, 20)}...`, 'info');
            } else {
                addResult('âŒ Supabase config not loaded', 'error');
            }
        }
        
        async function testClientCreation() {
            clearResults();
            addResult('ðŸ”§ Testing Supabase client creation...', 'info');
            
            try {
                // Wait for library
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (typeof window.supabase === 'undefined') {
                    addResult('âŒ Supabase library not available', 'error');
                    return;
                }
                
                if (typeof supabaseConfig === 'undefined') {
                    addResult('âŒ Supabase config not available', 'error');
                    return;
                }
                
                // Try to create client
                const supabaseLib = window.supabaseLib || window.supabase;
                const client = supabaseLib.createClient(supabaseConfig.url, supabaseConfig.anonKey);
                
                if (client && typeof client.from === 'function') {
                    addResult('âœ… Supabase client created successfully', 'success');
                    addResult(`ðŸ”§ Client type: ${typeof client}`, 'info');
                    addResult(`ðŸ“Š from() method available: ${typeof client.from === 'function'}`, 'info');
                    
                    // Store for other tests
                    window.testClient = client;
                } else {
                    addResult('âŒ Client created but from() method not available', 'error');
                }
                
            } catch (error) {
                addResult(`âŒ Error creating client: ${error.message}`, 'error');
            }
        }
        
        async function testDatabaseConnection() {
            clearResults();
            addResult('ðŸ”— Testing database connection...', 'info');
            
            try {
                if (!window.testClient) {
                    addResult('âš ï¸ No test client available, creating one...', 'info');
                    await testClientCreation();
                }
                
                if (!window.testClient) {
                    addResult('âŒ Cannot test connection without client', 'error');
                    return;
                }
                
                // Try a simple query to test connection
                const { data, error } = await window.testClient
                    .from('feedback')
                    .select('count(*)', { count: 'exact', head: true });
                
                if (error) {
                    addResult(`âŒ Database connection failed: ${error.message}`, 'error');
                } else {
                    addResult('âœ… Database connection successful', 'success');
                    addResult(`ðŸ“Š Feedback table accessible`, 'info');
                }
                
            } catch (error) {
                addResult(`âŒ Connection test error: ${error.message}`, 'error');
            }
        }
        
        async function testFeedbackInsertion() {
            clearResults();
            addResult('ðŸ“ Testing feedback insertion...', 'info');
            
            try {
                if (!window.testClient) {
                    addResult('âš ï¸ No test client available, creating one...', 'info');
                    await testClientCreation();
                }
                
                if (!window.testClient) {
                    addResult('âŒ Cannot test insertion without client', 'error');
                    return;
                }
                
                const testData = {
                    full_name: 'Connection Test User',
                    age: '25-35',
                    gender: 'á‹ˆáŠ•á‹µ',
                    education: 'á‹²áŒáˆª',
                    service_type: 'á‰…áŒ¥áˆ­ áŒ¥á‰ á‰ƒ áŠ áŒˆáˆáŒáˆŽá‰µ',
                    visit_purpose: 'Testing database connection',
                    staff_behavior: 5,
                    service_speed: 4,
                    service_quality: 5,
                    overall_satisfaction: 5,
                    staff_understanding: 4,
                    employee_empathy: 5,
                    needs_understanding: 4,
                    suggestions: 'This is a test feedback to verify the connection is working.',
                    complaints: '',
                    date_display: new Date().toLocaleDateString('am-ET'),
                    created_at: new Date().toISOString()
                };
                
                addResult('ðŸ“¤ Inserting test feedback...', 'info');
                
                const { data, error } = await window.testClient
                    .from('feedback')
                    .insert([testData])
                    .select();
                
                if (error) {
                    addResult(`âŒ Insertion failed: ${error.message}`, 'error');
                } else {
                    addResult('âœ… Test feedback inserted successfully', 'success');
                    addResult(`ðŸ“ Feedback ID: ${data[0].id}`, 'info');
                    
                    // Ask if user wants to delete the test entry
                    if (confirm('Test feedback inserted successfully! Delete the test entry?')) {
                        const { error: deleteError } = await window.testClient
                            .from('feedback')
                            .delete()
                            .eq('id', data[0].id);
                        
                        if (deleteError) {
                            addResult(`âš ï¸ Could not delete test entry: ${deleteError.message}`, 'error');
                        } else {
                            addResult('âœ… Test entry deleted successfully', 'success');
                        }
                    }
                }
                
            } catch (error) {
                addResult(`âŒ Insertion test error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run library test on load
        window.addEventListener('load', () => {
            setTimeout(testLibraryLoad, 1000);
        });
    </script>
</body>
</html>