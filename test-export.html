<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Export Functions</title>
</head>
<body>
    <h1>Test Export Functions</h1>
    
    <button onclick="addTestData()">Add Test Feedback Data</button>
    <button onclick="testExportAll()">Test Export All</button>
    <button onclick="testExportReport()">Test Export Report</button>
    
    <div id="status"></div>
    
    <script>
        function addTestData() {
            const testFeedbacks = [
                {
                    fullName: '·ä†·â†·â† ·ä®·â†·ã∞',
                    age: '26-35',
                    gender: 'male',
                    education: 'degree',
                    serviceType: 'security_guard',
                    visitPurpose: '·ã®·çÄ·å•·â≥ ·ä†·åà·àç·åç·àé·âµ ·àà·àò·å†·ã®·âÖ',
                    staff_behavior: '5',
                    service_speed: '4',
                    service_quality: '5',
                    overall_satisfaction: '4',
                    suggestions: '·â†·å£·àù ·å•·à© ·ä†·åà·àç·åç·àé·âµ ·äê·ãç',
                    complaints: '',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('am-ET')
                },
                {
                    fullName: '·çã·å¢·àõ ·ä†·àÖ·àò·ãµ',
                    age: '36-45',
                    gender: 'female',
                    education: 'diploma',
                    serviceType: 'peace_force',
                    visitPurpose: '·ã®·à∞·àã·àù ·à∞·à´·ãä·âµ ·ä†·åà·àç·åç·àé·âµ',
                    staff_behavior: '4',
                    service_speed: '5',
                    service_quality: '4',
                    overall_satisfaction: '5',
                    suggestions: '·çà·å£·äï ·ä•·äì ·å•·à© ·ä†·åà·àç·åç·àé·âµ',
                    complaints: '·àù·äï·àù ·âÖ·à¨·â≥ ·ã®·àà·àù',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('am-ET')
                },
                {
                    fullName: '·ã≥·ãä·âµ ·â∞·àµ·çã·ã¨',
                    age: '18-25',
                    gender: 'male',
                    education: 'secondary',
                    serviceType: 'conflict_resolution',
                    visitPurpose: '·åç·å≠·âµ ·àò·çç·â≥·âµ ·ä†·åà·àç·åç·àé·âµ',
                    staff_behavior: '3',
                    service_speed: '3',
                    service_quality: '4',
                    overall_satisfaction: '3',
                    suggestions: '·ã®·â†·àà·å† ·àõ·àª·àª·àç ·ã´·àµ·çà·àç·åã·àç',
                    complaints: '·âµ·äï·àΩ ·ãò·åç·ã≠·â∑·àç',
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('am-ET')
                }
            ];
            
            localStorage.setItem('feedbackSurveys', JSON.stringify(testFeedbacks));
            document.getElementById('status').innerHTML = '<p style="color: green;">‚úÖ Test data added successfully!</p>';
        }
        
        function testExportAll() {
            const data = localStorage.getItem('feedbackSurveys');
            if (!data) {
                document.getElementById('status').innerHTML = '<p style="color: red;">‚ùå No feedback data found. Add test data first.</p>';
                return;
            }
            
            const feedbacks = JSON.parse(data);
            document.getElementById('status').innerHTML = `<p style="color: blue;">üìä Found ${feedbacks.length} feedbacks. Testing export...</p>`;
            
            // Simulate the exportAllFeedback function
            testExportAllFeedback(feedbacks);
        }
        
        function testExportReport() {
            const data = localStorage.getItem('feedbackSurveys');
            if (!data) {
                document.getElementById('status').innerHTML = '<p style="color: red;">‚ùå No feedback data found. Add test data first.</p>';
                return;
            }
            
            const feedbacks = JSON.parse(data);
            document.getElementById('status').innerHTML = `<p style="color: blue;">üìà Found ${feedbacks.length} feedbacks. Testing report export...</p>`;
            
            // Simulate the exportFeedbackReport function
            testExportFeedbackReport(feedbacks);
        }
        
        function testExportAllFeedback(allFeedbacks) {
            console.log('üìä Testing exportAllFeedback function...');
            
            // Create comprehensive CSV content with all fields
            const headers = [
                '·àò·àà·ã´ ·âÅ·å•·à≠', '·àô·àâ ·àµ·àù', '·ä•·ãµ·àú', '·åæ·â≥', '·ã®·âµ·àù·àÖ·à≠·âµ ·ã∞·à®·åÉ', '·ã®·ä†·åà·àç·åç·àé·âµ ·ãì·ã≠·äê·âµ',
                '·ã®·åâ·â•·äù·âµ ·ãì·àã·àõ', '·ã®·à∞·à´·â∞·äû·âΩ ·â£·àÖ·à™', '·ã®·ä†·åà·àç·åç·àé·âµ ·çç·å•·äê·âµ', '·ã®·ä†·åà·àç·åç·àé·âµ ·å•·à´·âµ', 
                '·ä†·å†·âÉ·àã·ã≠ ·ä•·à≠·ä´·â≥', '·ä†·àõ·ä´·ã≠ ·ã∞·à®·åÉ', '·àà·àõ·àª·àª·ã´ ·àÄ·à≥·â¶·âΩ', '·âÖ·à¨·â≥·ãé·âΩ', '·âÄ·äï', '·à∞·ãì·âµ'
            ];
            
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for proper UTF-8 encoding
            
            allFeedbacks.forEach((feedback, index) => {
                // Calculate average rating
                const ratings = [
                    parseInt(feedback.staff_behavior || 0),
                    parseInt(feedback.service_speed || 0),
                    parseInt(feedback.service_quality || 0),
                    parseInt(feedback.overall_satisfaction || 0)
                ].filter(r => r > 0);
                
                const averageRating = ratings.length > 0 ? 
                    (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1) : 'N/A';
                
                // Map service types to Amharic
                const serviceTypeMap = {
                    'security_guard': '·âÖ·å•·à≠ ·å•·â†·âÉ ·ä†·åà·àç·åç·àé·âµ',
                    'peace_force': '·à∞·àã·àù ·à∞·à´·ãä·âµ',
                    'conflict_resolution': '·åç·å≠·âµ ·àò·çç·â≥·âµ',
                    'community_security': '·ã®·àõ·àÖ·â†·à®·à∞·â• ·çÄ·å•·â≥',
                    'risk_assessment': '·àµ·åã·âµ ·â¶·â≥ ·àò·àà·ã®·âµ',
                    'other': '·àå·àã'
                };
                
                const serviceType = serviceTypeMap[feedback.serviceType] || feedback.serviceType || '';
                
                // Extract time from timestamp
                const timestamp = feedback.timestamp ? new Date(feedback.timestamp) : new Date();
                const time = timestamp.toLocaleTimeString('am-ET');
                
                const row = [
                    index + 1, // ID number
                    `"${feedback.fullName || ''}"`,
                    feedback.age || '',
                    feedback.gender === 'male' ? '·ãà·äï·ãµ' : feedback.gender === 'female' ? '·à¥·âµ' : feedback.gender || '',
                    feedback.education || '',
                    serviceType,
                    `"${(feedback.visitPurpose || '').replace(/"/g, '""')}"`, // Escape quotes
                    feedback.staff_behavior || '',
                    feedback.service_speed || '',
                    feedback.service_quality || '',
                    feedback.overall_satisfaction || '',
                    averageRating,
                    `"${(feedback.suggestions || '').replace(/"/g, '""')}"`, // Escape quotes
                    `"${(feedback.complaints || '').replace(/"/g, '""')}"`, // Escape quotes
                    feedback.date || '',
                    time
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `·ã®·ä†·åà·àç·åç·àé·âµ_·åç·àù·åà·àõ_·àÅ·àâ·àù_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ All feedback exported successfully');
            document.getElementById('status').innerHTML = `<p style="color: green;">‚úÖ ${allFeedbacks.length} feedbacks exported successfully to CSV!</p>`;
        }
        
        function testExportFeedbackReport(allFeedbacks) {
            console.log('üìà Testing exportFeedbackReport function...');
            
            // Calculate statistics
            const stats = calculateFeedbackStatistics(allFeedbacks);
            
            // Create detailed report CSV
            let reportContent = '\uFEFF'; // BOM for UTF-8
            
            // Report Header
            reportContent += '·ã®·ä†·åà·àç·åç·àé·âµ ·åç·àù·åà·àõ ·ãù·à≠·ãù·à≠ ·à™·çñ·à≠·âµ\n';
            reportContent += `·à™·çñ·à≠·âµ ·âÄ·äï: ${new Date().toLocaleDateString('am-ET')}\n`;
            reportContent += `·å†·âÖ·àã·àã ·åç·àù·åà·àõ·ãé·âΩ: ${stats.totalFeedbacks}\n\n`;
            
            // Summary Statistics
            reportContent += '·ä†·å†·âÉ·àã·ã≠ ·àµ·â≥·â≤·àµ·â≤·ä≠·àµ\n';
            reportContent += '·àò·àà·ä™·ã´,·ãã·åã\n';
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·à∞·à´·â∞·äû·âΩ ·â£·àÖ·à™ ·ã∞·à®·åÉ,${stats.avgStaffBehavior}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·ä†·åà·àç·åç·àé·âµ ·çç·å•·äê·âµ ·ã∞·à®·åÉ,${stats.avgServiceSpeed}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·ä†·åà·àç·åç·àé·âµ ·å•·à´·âµ ·ã∞·à®·åÉ,${stats.avgServiceQuality}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ä†·å†·âÉ·àã·ã≠ ·ä•·à≠·ä´·â≥ ·ã∞·à®·åÉ,${stats.avgOverallSatisfaction}\n`;
            reportContent += `·ã®·ä•·à≠·ä´·â≥ ·àò·å†·äï (4+ ·äÆ·ä®·â•),${stats.satisfactionRate}%\n\n`;
            
            // Demographics
            reportContent += '·ã®·ä•·ãµ·àú ·ä≠·çç·çç·àç\n';
            reportContent += '·ä•·ãµ·àú ·ä≠·àç·àç,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.ageDistribution).forEach(([age, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                reportContent += `${age},${count},${percentage}%\n`;
            });
            
            reportContent += '\n·ã®·åæ·â≥ ·ä≠·çç·çç·àç\n';
            reportContent += '·åæ·â≥,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.genderDistribution).forEach(([gender, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                const genderAmharic = gender === 'male' ? '·ãà·äï·ãµ' : gender === 'female' ? '·à¥·âµ' : gender;
                reportContent += `${genderAmharic},${count},${percentage}%\n`;
            });
            
            reportContent += '\n·ã®·ä†·åà·àç·åç·àé·âµ ·ãì·ã≠·äê·âµ ·ä≠·çç·çç·àç\n';
            reportContent += '·ä†·åà·àç·åç·àé·âµ,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.serviceDistribution).forEach(([service, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                reportContent += `${service},${count},${percentage}%\n`;
            });
            
            // Download report
            const blob = new Blob([reportContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `·ã®·ä†·åà·àç·åç·àé·âµ_·åç·àù·åà·àõ_·à™·çñ·à≠·âµ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ Comprehensive report exported successfully');
            document.getElementById('status').innerHTML = `<p style="color: green;">‚úÖ Comprehensive report exported successfully!</p>`;
        }
        
        function calculateFeedbackStatistics(allFeedbacks) {
            const stats = {
                totalFeedbacks: allFeedbacks.length,
                avgStaffBehavior: 0,
                avgServiceSpeed: 0,
                avgServiceQuality: 0,
                avgOverallSatisfaction: 0,
                satisfactionRate: 0,
                ageDistribution: {},
                genderDistribution: {},
                serviceDistribution: {}
            };
            
            if (allFeedbacks.length === 0) return stats;
            
            let totalStaffBehavior = 0, totalServiceSpeed = 0, totalServiceQuality = 0, totalOverallSatisfaction = 0;
            let satisfiedCount = 0;
            
            allFeedbacks.forEach(feedback => {
                // Calculate averages
                const staffBehavior = parseInt(feedback.staff_behavior || 0);
                const serviceSpeed = parseInt(feedback.service_speed || 0);
                const serviceQuality = parseInt(feedback.service_quality || 0);
                const overallSatisfaction = parseInt(feedback.overall_satisfaction || 0);
                
                totalStaffBehavior += staffBehavior;
                totalServiceSpeed += serviceSpeed;
                totalServiceQuality += serviceQuality;
                totalOverallSatisfaction += overallSatisfaction;
                
                if (overallSatisfaction >= 4) satisfiedCount++;
                
                // Age distribution
                const age = feedback.age || 'Unknown';
                stats.ageDistribution[age] = (stats.ageDistribution[age] || 0) + 1;
                
                // Gender distribution
                const gender = feedback.gender || 'Unknown';
                stats.genderDistribution[gender] = (stats.genderDistribution[gender] || 0) + 1;
                
                // Service distribution
                const serviceTypeMap = {
                    'security_guard': '·âÖ·å•·à≠ ·å•·â†·âÉ ·ä†·åà·àç·åç·àé·âµ',
                    'peace_force': '·à∞·àã·àù ·à∞·à´·ãä·âµ',
                    'conflict_resolution': '·åç·å≠·âµ ·àò·çç·â≥·âµ',
                    'community_security': '·ã®·àõ·àÖ·â†·à®·à∞·â• ·çÄ·å•·â≥',
                    'risk_assessment': '·àµ·åã·âµ ·â¶·â≥ ·àò·àà·ã®·âµ',
                    'other': '·àå·àã'
                };
                const service = serviceTypeMap[feedback.serviceType] || feedback.serviceType || 'Unknown';
                stats.serviceDistribution[service] = (stats.serviceDistribution[service] || 0) + 1;
            });
            
            // Calculate averages
            stats.avgStaffBehavior = (totalStaffBehavior / allFeedbacks.length).toFixed(1);
            stats.avgServiceSpeed = (totalServiceSpeed / allFeedbacks.length).toFixed(1);
            stats.avgServiceQuality = (totalServiceQuality / allFeedbacks.length).toFixed(1);
            stats.avgOverallSatisfaction = (totalOverallSatisfaction / allFeedbacks.length).toFixed(1);
            stats.satisfactionRate = Math.round((satisfiedCount / allFeedbacks.length) * 100);
            
            return stats;
        }
    </script>
</body>
</html>