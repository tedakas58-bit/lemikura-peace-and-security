<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Column Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Database Column Test</h1>
    <p>This page will check if your database has the new 'images' column and help fix any issues.</p>
    
    <button onclick="testDatabaseStructure()">Test Database Structure</button>
    <button onclick="testNewsLoading()">Test News Loading</button>
    <button onclick="addTestColumn()">Add Images Column</button>
    
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <script>
        let supabase;
        
        // Initialize Supabase
        async function initSupabase() {
            if (typeof window.supabase !== 'undefined') {
                supabase = window.supabase.createClient(
                    'https://asfrnjaegyzwpseryawi.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzZnJuamFlZ3l6d3BzZXJ5YXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDg4OTAsImV4cCI6MjA4MjQyNDg5MH0.7vLsda2lKd-9zEyeNJgGXQ39TmN1XZ-TfI4BHM_eWD8'
                );
                return true;
            }
            return false;
        }
        
        function addResult(type, title, message, details = null) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            
            let html = `<h3>${title}</h3><p>${message}</p>`;
            if (details) {
                html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testDatabaseStructure() {
            if (!supabase) {
                addResult('error', 'Connection Error', 'Supabase not initialized');
                return;
            }
            
            try {
                // Try to select with images column
                const { data, error } = await supabase
                    .from('news')
                    .select('id, title, image, images')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('images')) {
                        addResult('error', 'Missing Column', 'The "images" column does not exist in your database. You need to add it.', error);
                    } else {
                        addResult('error', 'Database Error', error.message, error);
                    }
                } else {
                    addResult('success', 'Column Exists', 'The "images" column exists in your database!', data);
                }
            } catch (err) {
                addResult('error', 'Test Failed', err.message, err);
            }
        }
        
        async function testNewsLoading() {
            if (!supabase) {
                addResult('error', 'Connection Error', 'Supabase not initialized');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('news')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    addResult('error', 'Loading Error', error.message, error);
                } else {
                    // Test parsing each item
                    const results = data.map(item => {
                        try {
                            let images;
                            if (item.images && item.images.trim() !== '') {
                                images = JSON.parse(item.images);
                            } else {
                                images = [item.image || 'images/hero-bg.jpg'];
                            }
                            return { id: item.id, title: item.title, images: images, status: 'OK' };
                        } catch (parseError) {
                            return { id: item.id, title: item.title, error: parseError.message, status: 'ERROR' };
                        }
                    });
                    
                    const errors = results.filter(r => r.status === 'ERROR');
                    if (errors.length > 0) {
                        addResult('error', 'Parsing Errors', `${errors.length} items have JSON parsing errors`, errors);
                    } else {
                        addResult('success', 'Loading Success', `Successfully loaded and parsed ${results.length} news items`, results);
                    }
                }
            } catch (err) {
                addResult('error', 'Test Failed', err.message, err);
            }
        }
        
        async function addTestColumn() {
            if (!supabase) {
                addResult('error', 'Connection Error', 'Supabase not initialized');
                return;
            }
            
            try {
                // Try to add the column using RPC or direct SQL
                const { data, error } = await supabase.rpc('exec_sql', {
                    sql: "ALTER TABLE news ADD COLUMN IF NOT EXISTS images JSONB DEFAULT '[]'::jsonb;"
                });
                
                if (error) {
                    addResult('info', 'Manual SQL Required', 'Cannot add column via RPC. Please run this SQL manually in Supabase Dashboard:', 
                        "ALTER TABLE news ADD COLUMN IF NOT EXISTS images JSONB DEFAULT '[]'::jsonb;");
                } else {
                    addResult('success', 'Column Added', 'Successfully added images column to database!', data);
                }
            } catch (err) {
                addResult('info', 'Manual SQL Required', 'Please run this SQL manually in your Supabase Dashboard ‚Üí SQL Editor:', 
                    "ALTER TABLE news ADD COLUMN IF NOT EXISTS images JSONB DEFAULT '[]'::jsonb;");
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            const initialized = await initSupabase();
            if (initialized) {
                addResult('success', 'Connected', 'Successfully connected to Supabase database');
                // Auto-test structure
                setTimeout(testDatabaseStructure, 1000);
            } else {
                addResult('error', 'Connection Failed', 'Could not connect to Supabase');
            }
        });
    </script>
</body>
</html>