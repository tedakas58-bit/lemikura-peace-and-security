<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin Export Functions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d7d7e;
            text-align: center;
            margin-bottom: 30px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #2d7d7e;
            color: white;
        }
        .btn-primary:hover {
            background: #1e5a5b;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2d7d7e;
            background: #f8f9fa;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        .data-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Admin Export Functions Test</h1>
        
        <div class="button-group">
            <button class="btn-secondary" onclick="addTestData()">
                üìä Add Test Feedback Data
            </button>
            <button class="btn-primary" onclick="checkData()">
                üîç Check Current Data
            </button>
            <button class="btn-success" onclick="testExportAll()">
                üì• Test Export All Feedback
            </button>
            <button class="btn-success" onclick="testExportReport()">
                üìà Test Export Report
            </button>
            <button class="btn-secondary" onclick="clearData()">
                üóëÔ∏è Clear Test Data
            </button>
        </div>
        
        <div id="status" class="status">
            Ready to test export functions. Click "Add Test Feedback Data" first.
        </div>
        
        <div id="dataPreview" class="data-preview" style="display: none;"></div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }
        
        function addTestData() {
            const testFeedbacks = [
                {
                    fullName: '·ä†·â†·â† ·ä®·â†·ã∞',
                    age: '26-35',
                    gender: 'male',
                    education: 'degree',
                    serviceType: 'security_guard',
                    visitPurpose: '·ã®·çÄ·å•·â≥ ·ä†·åà·àç·åç·àé·âµ ·àà·àò·å†·ã®·âÖ ·àò·å•·âª·àà·àÅ·ç¢ ·â†·å£·àù ·å•·à© ·ä†·åà·àç·åç·àé·âµ ·äê·ãç·ç¢',
                    staff_behavior: '5',
                    service_speed: '4',
                    service_quality: '5',
                    overall_satisfaction: '4',
                    suggestions: '·â†·å£·àù ·å•·à© ·ä†·åà·àç·åç·àé·âµ ·äê·ãç·ç¢ ·ã≠·àÖ·äï·äï ·ã≠·âÄ·å•·àâ·ç¢',
                    complaints: '',
                    timestamp: new Date('2024-12-20T10:30:00').toISOString(),
                    date: new Date('2024-12-20').toLocaleDateString('am-ET')
                },
                {
                    fullName: '·çã·å¢·àõ ·ä†·àÖ·àò·ãµ',
                    age: '36-45',
                    gender: 'female',
                    education: 'diploma',
                    serviceType: 'peace_force',
                    visitPurpose: '·ã®·à∞·àã·àù ·à∞·à´·ãä·âµ ·ä†·åà·àç·åç·àé·âµ ·àà·àò·å†·ã®·âÖ',
                    staff_behavior: '4',
                    service_speed: '5',
                    service_quality: '4',
                    overall_satisfaction: '5',
                    suggestions: '·çà·å£·äï ·ä•·äì ·å•·à© ·ä†·åà·àç·åç·àé·âµ·ç¢ ·â†·å£·àù ·ä•·äì·àò·à∞·åç·äì·àà·äï·ç¢',
                    complaints: '·àù·äï·àù ·âÖ·à¨·â≥ ·ã®·àà·àù',
                    timestamp: new Date('2024-12-21T14:15:00').toISOString(),
                    date: new Date('2024-12-21').toLocaleDateString('am-ET')
                },
                {
                    fullName: '·ã≥·ãä·âµ ·â∞·àµ·çã·ã¨',
                    age: '18-25',
                    gender: 'male',
                    education: 'secondary',
                    serviceType: 'conflict_resolution',
                    visitPurpose: '·åç·å≠·âµ ·àò·çç·â≥·âµ ·ä†·åà·àç·åç·àé·âµ ·àà·àò·å†·ã®·âÖ',
                    staff_behavior: '3',
                    service_speed: '3',
                    service_quality: '4',
                    overall_satisfaction: '3',
                    suggestions: '·ã®·â†·àà·å† ·àõ·àª·àª·àç ·ã´·àµ·çà·àç·åã·àç·ç¢ ·çç·å•·äê·â±·äï ·àõ·àª·àª·àç ·ã≠·äñ·à≠·â£·â∏·ãã·àç·ç¢',
                    complaints: '·âµ·äï·àΩ ·ãò·åç·ã≠·â∑·àç·ç¢ ·ã®·â†·àà·å† ·çà·å£·äï ·ä†·åà·àç·åç·àé·âµ ·ã≠·çà·àç·åã·àç·ç¢',
                    timestamp: new Date('2024-12-22T09:45:00').toISOString(),
                    date: new Date('2024-12-22').toLocaleDateString('am-ET')
                },
                {
                    fullName: '·à≥·à´ ·åà·â•·à¨',
                    age: '46-55',
                    gender: 'female',
                    education: 'masters',
                    serviceType: 'community_security',
                    visitPurpose: '·ã®·àõ·àÖ·â†·à®·à∞·â• ·çÄ·å•·â≥ ·åâ·ã≥·ã≠ ·àà·àõ·äê·à≥·à≥·âµ',
                    staff_behavior: '5',
                    service_speed: '5',
                    service_quality: '5',
                    overall_satisfaction: '5',
                    suggestions: '·ä•·åÖ·åç ·â†·å£·àù ·å•·à© ·ä†·åà·àç·åç·àé·âµ·ç¢ ·àÅ·àâ·àù ·äê·åà·à≠ ·çç·åπ·àù ·äê·ãç·ç¢',
                    complaints: '',
                    timestamp: new Date('2024-12-23T16:20:00').toISOString(),
                    date: new Date('2024-12-23').toLocaleDateString('am-ET')
                },
                {
                    fullName: '·àò·àÄ·àò·ãµ ·ã©·à±·çç',
                    age: '56+',
                    gender: 'male',
                    education: 'primary',
                    serviceType: 'risk_assessment',
                    visitPurpose: '·àµ·åã·âµ ·â¶·â≥ ·àò·àà·ã®·âµ ·ä†·åà·àç·åç·àé·âµ',
                    staff_behavior: '4',
                    service_speed: '3',
                    service_quality: '4',
                    overall_satisfaction: '4',
                    suggestions: '·å•·à© ·ä†·åà·àç·åç·àé·âµ ·äê·ãç·ç¢ ·âµ·äï·àΩ ·àõ·àª·àª·àç ·ã≠·äñ·à≠·â†·â≥·àç·ç¢',
                    complaints: '·âµ·äï·àΩ ·ãò·åç·ã≠·â∑·àç ·åç·äï ·â†·ä†·å†·âÉ·àã·ã≠ ·å•·à© ·äê·ãç·ç¢',
                    timestamp: new Date('2024-12-24T11:10:00').toISOString(),
                    date: new Date('2024-12-24').toLocaleDateString('am-ET')
                }
            ];
            
            localStorage.setItem('feedbackSurveys', JSON.stringify(testFeedbacks));
            updateStatus(`‚úÖ Successfully added ${testFeedbacks.length} test feedback entries to localStorage!`, 'success');
            
            // Show preview
            const preview = document.getElementById('dataPreview');
            preview.style.display = 'block';
            preview.innerHTML = `<strong>Sample Data Preview:</strong><br>${JSON.stringify(testFeedbacks[0], null, 2)}`;
        }
        
        function checkData() {
            const data = localStorage.getItem('feedbackSurveys');
            if (!data) {
                updateStatus('‚ùå No feedback data found in localStorage. Add test data first.', 'error');
                document.getElementById('dataPreview').style.display = 'none';
                return;
            }
            
            try {
                const feedbacks = JSON.parse(data);
                updateStatus(`üìä Found ${feedbacks.length} feedback entries in localStorage`, 'success');
                
                // Show statistics
                const stats = calculateBasicStats(feedbacks);
                const preview = document.getElementById('dataPreview');
                preview.style.display = 'block';
                preview.innerHTML = `
                    <strong>Data Statistics:</strong><br>
                    Total Feedbacks: ${stats.total}<br>
                    Average Rating: ${stats.avgRating}<br>
                    Gender Distribution: ${JSON.stringify(stats.genderDist)}<br>
                    Service Distribution: ${JSON.stringify(stats.serviceDist)}
                `;
            } catch (error) {
                updateStatus(`‚ùå Error parsing feedback data: ${error.message}`, 'error');
            }
        }
        
        function calculateBasicStats(feedbacks) {
            const stats = {
                total: feedbacks.length,
                avgRating: 0,
                genderDist: {},
                serviceDist: {}
            };
            
            let totalRating = 0;
            let ratingCount = 0;
            
            feedbacks.forEach(feedback => {
                // Calculate average rating
                ['staff_behavior', 'service_speed', 'service_quality', 'overall_satisfaction'].forEach(rating => {
                    if (feedback[rating]) {
                        totalRating += parseInt(feedback[rating]);
                        ratingCount++;
                    }
                });
                
                // Gender distribution
                const gender = feedback.gender || 'Unknown';
                stats.genderDist[gender] = (stats.genderDist[gender] || 0) + 1;
                
                // Service distribution
                const service = feedback.serviceType || 'Unknown';
                stats.serviceDist[service] = (stats.serviceDist[service] || 0) + 1;
            });
            
            stats.avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : 0;
            return stats;
        }
        
        function testExportAll() {
            const data = localStorage.getItem('feedbackSurveys');
            if (!data) {
                updateStatus('‚ùå No feedback data found. Add test data first.', 'error');
                return;
            }
            
            try {
                const feedbacks = JSON.parse(data);
                updateStatus(`üì• Testing Export All function with ${feedbacks.length} feedbacks...`, 'info');
                
                // Simulate the exportAllFeedback function
                exportAllFeedback(feedbacks);
                
                setTimeout(() => {
                    updateStatus(`‚úÖ Export All function test completed! Check your downloads folder for the CSV file.`, 'success');
                }, 1000);
                
            } catch (error) {
                updateStatus(`‚ùå Error during export: ${error.message}`, 'error');
            }
        }
        
        function testExportReport() {
            const data = localStorage.getItem('feedbackSurveys');
            if (!data) {
                updateStatus('‚ùå No feedback data found. Add test data first.', 'error');
                return;
            }
            
            try {
                const feedbacks = JSON.parse(data);
                updateStatus(`üìà Testing Export Report function with ${feedbacks.length} feedbacks...`, 'info');
                
                // Simulate the exportFeedbackReport function
                exportFeedbackReport(feedbacks);
                
                setTimeout(() => {
                    updateStatus(`‚úÖ Export Report function test completed! Check your downloads folder for the report CSV file.`, 'success');
                }, 1000);
                
            } catch (error) {
                updateStatus(`‚ùå Error during report export: ${error.message}`, 'error');
            }
        }
        
        function clearData() {
            localStorage.removeItem('feedbackSurveys');
            updateStatus('üóëÔ∏è Test data cleared from localStorage', 'info');
            document.getElementById('dataPreview').style.display = 'none';
        }
        
        // Export functions (copied from admin-simple.js for testing)
        function exportAllFeedback(allFeedbacks) {
            console.log('üìä Exporting all feedback data...');
            
            // Create comprehensive CSV content with all fields
            const headers = [
                '·àò·àà·ã´ ·âÅ·å•·à≠', '·àô·àâ ·àµ·àù', '·ä•·ãµ·àú', '·åæ·â≥', '·ã®·âµ·àù·àÖ·à≠·âµ ·ã∞·à®·åÉ', '·ã®·ä†·åà·àç·åç·àé·âµ ·ãì·ã≠·äê·âµ',
                '·ã®·åâ·â•·äù·âµ ·ãì·àã·àõ', '·ã®·à∞·à´·â∞·äû·âΩ ·â£·àÖ·à™', '·ã®·ä†·åà·àç·åç·àé·âµ ·çç·å•·äê·âµ', '·ã®·ä†·åà·àç·åç·àé·âµ ·å•·à´·âµ', 
                '·ä†·å†·âÉ·àã·ã≠ ·ä•·à≠·ä´·â≥', '·ä†·àõ·ä´·ã≠ ·ã∞·à®·åÉ', '·àà·àõ·àª·àª·ã´ ·àÄ·à≥·â¶·âΩ', '·âÖ·à¨·â≥·ãé·âΩ', '·âÄ·äï', '·à∞·ãì·âµ'
            ];
            
            let csvContent = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for proper UTF-8 encoding
            
            allFeedbacks.forEach((feedback, index) => {
                // Calculate average rating
                const ratings = [
                    parseInt(feedback.staff_behavior || 0),
                    parseInt(feedback.service_speed || 0),
                    parseInt(feedback.service_quality || 0),
                    parseInt(feedback.overall_satisfaction || 0)
                ].filter(r => r > 0);
                
                const averageRating = ratings.length > 0 ? 
                    (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1) : 'N/A';
                
                // Map service types to Amharic
                const serviceTypeMap = {
                    'security_guard': '·âÖ·å•·à≠ ·å•·â†·âÉ ·ä†·åà·àç·åç·àé·âµ',
                    'peace_force': '·à∞·àã·àù ·à∞·à´·ãä·âµ',
                    'conflict_resolution': '·åç·å≠·âµ ·àò·çç·â≥·âµ',
                    'community_security': '·ã®·àõ·àÖ·â†·à®·à∞·â• ·çÄ·å•·â≥',
                    'risk_assessment': '·àµ·åã·âµ ·â¶·â≥ ·àò·àà·ã®·âµ',
                    'other': '·àå·àã'
                };
                
                const serviceType = serviceTypeMap[feedback.serviceType] || feedback.serviceType || '';
                
                // Extract time from timestamp
                const timestamp = feedback.timestamp ? new Date(feedback.timestamp) : new Date();
                const time = timestamp.toLocaleTimeString('am-ET');
                
                const row = [
                    index + 1, // ID number
                    `"${feedback.fullName || ''}"`,
                    feedback.age || '',
                    feedback.gender === 'male' ? '·ãà·äï·ãµ' : feedback.gender === 'female' ? '·à¥·âµ' : feedback.gender || '',
                    feedback.education || '',
                    serviceType,
                    `"${(feedback.visitPurpose || '').replace(/"/g, '""')}"`, // Escape quotes
                    feedback.staff_behavior || '',
                    feedback.service_speed || '',
                    feedback.service_quality || '',
                    feedback.overall_satisfaction || '',
                    averageRating,
                    `"${(feedback.suggestions || '').replace(/"/g, '""')}"`, // Escape quotes
                    `"${(feedback.complaints || '').replace(/"/g, '""')}"`, // Escape quotes
                    feedback.date || '',
                    time
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `·ã®·ä†·åà·àç·åç·àé·âµ_·åç·àù·åà·àõ_·àÅ·àâ·àù_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ All feedback exported successfully');
        }
        
        function exportFeedbackReport(allFeedbacks) {
            console.log('üìà Generating comprehensive feedback report...');
            
            // Calculate statistics
            const stats = calculateFeedbackStatistics(allFeedbacks);
            
            // Create detailed report CSV
            let reportContent = '\uFEFF'; // BOM for UTF-8
            
            // Report Header
            reportContent += '·ã®·ä†·åà·àç·åç·àé·âµ ·åç·àù·åà·àõ ·ãù·à≠·ãù·à≠ ·à™·çñ·à≠·âµ\n';
            reportContent += `·à™·çñ·à≠·âµ ·âÄ·äï: ${new Date().toLocaleDateString('am-ET')}\n`;
            reportContent += `·å†·âÖ·àã·àã ·åç·àù·åà·àõ·ãé·âΩ: ${stats.totalFeedbacks}\n\n`;
            
            // Summary Statistics
            reportContent += '·ä†·å†·âÉ·àã·ã≠ ·àµ·â≥·â≤·àµ·â≤·ä≠·àµ\n';
            reportContent += '·àò·àà·ä™·ã´,·ãã·åã\n';
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·à∞·à´·â∞·äû·âΩ ·â£·àÖ·à™ ·ã∞·à®·åÉ,${stats.avgStaffBehavior}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·ä†·åà·àç·åç·àé·âµ ·çç·å•·äê·âµ ·ã∞·à®·åÉ,${stats.avgServiceSpeed}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ã®·ä†·åà·àç·åç·àé·âµ ·å•·à´·âµ ·ã∞·à®·åÉ,${stats.avgServiceQuality}\n`;
            reportContent += `·ä†·àõ·ä´·ã≠ ·ä†·å†·âÉ·àã·ã≠ ·ä•·à≠·ä´·â≥ ·ã∞·à®·åÉ,${stats.avgOverallSatisfaction}\n`;
            reportContent += `·ã®·ä•·à≠·ä´·â≥ ·àò·å†·äï (4+ ·äÆ·ä®·â•),${stats.satisfactionRate}%\n\n`;
            
            // Demographics
            reportContent += '·ã®·ä•·ãµ·àú ·ä≠·çç·çç·àç\n';
            reportContent += '·ä•·ãµ·àú ·ä≠·àç·àç,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.ageDistribution).forEach(([age, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                reportContent += `${age},${count},${percentage}%\n`;
            });
            
            reportContent += '\n·ã®·åæ·â≥ ·ä≠·çç·çç·àç\n';
            reportContent += '·åæ·â≥,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.genderDistribution).forEach(([gender, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                const genderAmharic = gender === 'male' ? '·ãà·äï·ãµ' : gender === 'female' ? '·à¥·âµ' : gender;
                reportContent += `${genderAmharic},${count},${percentage}%\n`;
            });
            
            reportContent += '\n·ã®·ä†·åà·àç·åç·àé·âµ ·ãì·ã≠·äê·âµ ·ä≠·çç·çç·àç\n';
            reportContent += '·ä†·åà·àç·åç·àé·âµ,·âÅ·å•·à≠,·àò·â∂·äõ\n';
            Object.entries(stats.serviceDistribution).forEach(([service, count]) => {
                const percentage = ((count / stats.totalFeedbacks) * 100).toFixed(1);
                reportContent += `${service},${count},${percentage}%\n`;
            });
            
            // Download report
            const blob = new Blob([reportContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `·ã®·ä†·åà·àç·åç·àé·âµ_·åç·àù·åà·àõ_·à™·çñ·à≠·âµ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ Comprehensive report exported successfully');
        }
        
        function calculateFeedbackStatistics(allFeedbacks) {
            const stats = {
                totalFeedbacks: allFeedbacks.length,
                avgStaffBehavior: 0,
                avgServiceSpeed: 0,
                avgServiceQuality: 0,
                avgOverallSatisfaction: 0,
                satisfactionRate: 0,
                ageDistribution: {},
                genderDistribution: {},
                serviceDistribution: {}
            };
            
            if (allFeedbacks.length === 0) return stats;
            
            let totalStaffBehavior = 0, totalServiceSpeed = 0, totalServiceQuality = 0, totalOverallSatisfaction = 0;
            let satisfiedCount = 0;
            
            allFeedbacks.forEach(feedback => {
                // Calculate averages
                const staffBehavior = parseInt(feedback.staff_behavior || 0);
                const serviceSpeed = parseInt(feedback.service_speed || 0);
                const serviceQuality = parseInt(feedback.service_quality || 0);
                const overallSatisfaction = parseInt(feedback.overall_satisfaction || 0);
                
                totalStaffBehavior += staffBehavior;
                totalServiceSpeed += serviceSpeed;
                totalServiceQuality += serviceQuality;
                totalOverallSatisfaction += overallSatisfaction;
                
                if (overallSatisfaction >= 4) satisfiedCount++;
                
                // Age distribution
                const age = feedback.age || 'Unknown';
                stats.ageDistribution[age] = (stats.ageDistribution[age] || 0) + 1;
                
                // Gender distribution
                const gender = feedback.gender || 'Unknown';
                stats.genderDistribution[gender] = (stats.genderDistribution[gender] || 0) + 1;
                
                // Service distribution
                const serviceTypeMap = {
                    'security_guard': '·âÖ·å•·à≠ ·å•·â†·âÉ ·ä†·åà·àç·åç·àé·âµ',
                    'peace_force': '·à∞·àã·àù ·à∞·à´·ãä·âµ',
                    'conflict_resolution': '·åç·å≠·âµ ·àò·çç·â≥·âµ',
                    'community_security': '·ã®·àõ·àÖ·â†·à®·à∞·â• ·çÄ·å•·â≥',
                    'risk_assessment': '·àµ·åã·âµ ·â¶·â≥ ·àò·àà·ã®·âµ',
                    'other': '·àå·àã'
                };
                const service = serviceTypeMap[feedback.serviceType] || feedback.serviceType || 'Unknown';
                stats.serviceDistribution[service] = (stats.serviceDistribution[service] || 0) + 1;
            });
            
            // Calculate averages
            stats.avgStaffBehavior = (totalStaffBehavior / allFeedbacks.length).toFixed(1);
            stats.avgServiceSpeed = (totalServiceSpeed / allFeedbacks.length).toFixed(1);
            stats.avgServiceQuality = (totalServiceQuality / allFeedbacks.length).toFixed(1);
            stats.avgOverallSatisfaction = (totalOverallSatisfaction / allFeedbacks.length).toFixed(1);
            stats.satisfactionRate = Math.round((satisfiedCount / allFeedbacks.length) * 100);
            
            return stats;
        }
    </script>
</body>
</html>